<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ITST – 5ª · Lez3_9 · Variabili d'ambiente e superglobali PHP</title>
  <link rel="stylesheet" href="../style.css" />
  <link rel="stylesheet" href="../default.css" />
  <script src="../highlight.js"></script>
  <script>
    try { hljs.highlightAll(); } catch (e) {}
    function prevSlide(){ window.location.href = "lez3_8.html"; }
    function nextSlide(){ window.location.href = "lez3_10.html"; }
    function toggleMenu(){ document.getElementById('menu').classList.toggle('open'); }
  </script>
</head>
<body>
  <!-- BEGIN MENU -->
  <button class="menu-toggle" onclick="toggleMenu()">&#9776; Menu</button>
  <div class="sidebar" id="menu">
    <h2>Lezione 3 — PHP + MySQL + HTML/CSS</h2>
    <ul>
      <li><a href="lez3_1.html">Lez3.1: Obiettivi e percorso</a></li>
      <li><a href="lez3_2.html">Lez3.2: Ripasso e flusso richiesta/risposta</a></li>
      <li><a href="lez3_3.html">Lez3.3: Setup ambiente</a></li>
      <li><a href="lez3_4.html">Lez3.4: Primo script PHP</a></li>
      <li><a href="lez3_5.html">Lez3.5: Sintassi base e tipi</a></li>
      <li><a href="lez3_6.html">Lez3.6: Datatype fondamentali e array</a></li>
      <li><a href="lez3_7.html">Lez3.7: Array indicizzati</a></li>
      <li><a href="lez3_8.html">Lez3.8: Esercizi PHP (soluzioni)</a></li>
      <li><a href="lez3_9.html">Lez3.9: Variabili d'ambiente e superglobali</a></li>
      <li><a href="lez3_10.html">Lez3.10: Funzioni in PHP</a></li>
      <li><a href="piano.html#lez3-11">Lez3.11: Query e prepared statements</a></li>
      <li><a href="piano.html#lez3-12">Lez3.12: Integrazione HTML/CSS e sicurezza</a></li>
    </ul>
  </div>
  <!-- END MENU -->

  <div class="slide">
    <h1>Variabili d'ambiente e superglobali PHP</h1>

    <div class="nav-buttons" style="margin-bottom:10px">
      <button onclick="prevSlide()">&#8592; Indietro</button>
      <button onclick="nextSlide()">Avanti &#8594;</button>
    </div>

    <div class="content-box">
      <div class="inner-box">
        <p class="note">Le superglobali sono array speciali sempre disponibili in ogni punto dello script. Offrono accesso diretto a input utente, informazioni di contesto e stato dell'applicazione. Qui trovi descrizioni estese e snippet pronti all'uso.</p>

        <div class="box">
          <h2>$_GET — Parametri in query string</h2>
          <p>Contiene i parametri passati via URL (es. <code>pagina.php?nome=Anna&eta=17</code>). Non modifica mai lo stato del server ed è usato per filtri, ricerche e navigazione. I valori arrivano come stringhe: valida e sanifica sempre.</p>
          <pre><code class="language-php">&lt;?php
// pagina.php?nome=Anna&amp;eta=17
$nome = $_GET['nome'] ?? 'ospite';
$eta  = $_GET['eta'] ?? 'n/d';

echo "Ciao $nome, ho ricevuto età: $eta";
?&gt;</code></pre>
          <p class="note">Esempio diretto senza <code>filter_input</code>: è semplice ma espone a XSS/validazioni mancanti. Vedi sotto la sezione di approfondimento per gestire correttamente gli input.</p>
        </div>

        <div class="box">
          <h2>$_POST — Dati inviati da form</h2>
          <p>Raccoglie i campi di un modulo con <code>method="POST"</code>. È preferito per dati sensibili (password) o corposi. Ricorda di abilitare <code>enctype="multipart/form-data"</code> se il form include upload.</p>
          <pre><code class="language-php">&lt;form action="salva-contatto.php" method="POST"&gt;
  &lt;input name="email" type="email" required&gt;
  &lt;textarea name="messaggio" required&gt;&lt;/textarea&gt;
  &lt;button type="submit"&gt;Invia&lt;/button&gt;
&lt;/form&gt;

&lt;?php // salva-contatto.php
$email = $_POST['email'] ?? null;
$msg   = $_POST['messaggio'] ?? null;

if (!$email || !$msg) {
  exit('Dati mancanti');
}

echo "Grazie, contatteremo $email. Messaggio: $msg";
?&gt;</code></pre>
          <p class="note">Esempio base senza sanificazione: funziona ma non filtra valori non validi e non protegge da HTML indesiderato.</p>
        </div>

        <div class="box">
          <h2>filter_input / filter_input_array — sanificazione e validazione</h2>
          <p>Queste funzioni applicano filtri standard agli input provenienti da <code>$_GET</code>, <code>$_POST</code>, <code>$_COOKIE</code> e <code>$_SERVER</code>. Operano in tre passaggi: scelta della sorgente (<code>INPUT_GET</code>, <code>INPUT_POST</code>, ecc.), selezione del filtro e definizione di opzioni/flag.</p>
          <ul>
            <li><strong>Sanitize</strong>: rimuove/escapa caratteri indesiderati (es. <code>FILTER_SANITIZE_SPECIAL_CHARS</code>, <code>FILTER_SANITIZE_EMAIL</code>).</li>
            <li><strong>Validate</strong>: verifica il formato (es. <code>FILTER_VALIDATE_INT</code>, <code>FILTER_VALIDATE_EMAIL</code>), restituendo <code>false</code> se non valido.</li>
            <li><strong>Opzioni</strong>: array <code>['options' =&gt; [...], 'flags' =&gt; ...]</code> per impostare vincoli (<code>min_range</code>, <code>max_range</code>, <code>default</code>, <code>FILTER_FLAG_ALLOW_FRACTION</code>, <code>FILTER_FLAG_STRIP_LOW</code>, ecc.).</li>
            <li><strong>Array di filtri</strong>: con <code>filter_input_array</code> definisci una mappa di filtri per più campi in un'unica chiamata.</li>
            <li><strong>Fall-back</strong>: se la chiave non esiste, restituisce <code>null</code>; se la validazione fallisce, <code>false</code>. Gestisci entrambi i casi.</li>
          </ul>
          <pre><code class="language-php">&lt;?php
// Versione sicura per $_GET
$nome = filter_input(INPUT_GET, 'nome', FILTER_SANITIZE_SPECIAL_CHARS);
$eta  = filter_input(INPUT_GET, 'eta', FILTER_VALIDATE_INT, [
  'options' => ['min_range' => 1, 'max_range' => 120]
]);

$etaDescrizione = $eta === false ? 'età non valida' : ($eta === null ? 'nessuna età' : $eta . ' anni');
echo "Ciao $nome, ho ricevuto $etaDescrizione";

// Versione sicura per $_POST
$input = filter_input_array(INPUT_POST, [
  'email' => ['filter' => FILTER_VALIDATE_EMAIL],
  'messaggio' => ['filter' => FILTER_SANITIZE_SPECIAL_CHARS]
]);

if (!$input['email'] || !$input['messaggio']) {
  exit('Dati mancanti o invalidi');
}

echo "Grazie, contatteremo {$input['email']}. Messaggio: {$input['messaggio']}";
?&gt;</code></pre>
          <p class="note">Alternativa avanzata: <code>filter_var</code> filtra valori già in memoria; <code>FILTER_DEFAULT</code> restituisce la stringa così com'è ma puoi aggiungere flag per rimuovere tag HTML (<code>FILTER_FLAG_NO_ENCODE_QUOTES</code> o <code>FILTER_SANITIZE_FULL_SPECIAL_CHARS</code>).</p>
        </div>

        <div class="box">
          <h2>$_FILES — Upload di file</h2>
          <p>Array bidimensionale che descrive ogni file caricato: nome originale, tipo MIME dichiarato, dimensione, eventuale codice di errore e percorso temporaneo. Verifica sempre <code>error</code> e tipo reale del file prima di salvarlo.</p>
          <pre><code class="language-php">&lt;form action="upload.php" method="POST" enctype="multipart/form-data"&gt;
  &lt;input type="file" name="curriculum" accept="application/pdf" required&gt;
  &lt;button type="submit"&gt;Carica PDF&lt;/button&gt;
&lt;/form&gt;

&lt;?php // upload.php
if (!isset($_FILES['curriculum'])) {
  exit('Nessun file inviato');
}
$file = $_FILES['curriculum'];

if ($file['error'] !== UPLOAD_ERR_OK) {
  exit('Errore di upload: ' . $file['error']);
}

// Controllo del MIME reale
$finfo = finfo_open(FILEINFO_MIME_TYPE);
$mime = finfo_file($finfo, $file['tmp_name']);
finfo_close($finfo);

if ($mime !== 'application/pdf') {
  exit('Sono accettati solo PDF');
}

$dest = __DIR__ . '/uploads/' . basename($file['name']);
if (move_uploaded_file($file['tmp_name'], $dest)) {
  echo 'File caricato correttamente!';
} else {
  echo 'Impossibile salvare il file';
}
?&gt;</code></pre>
        </div>

        <div class="box">
          <h2>$_SERVER — Contesto della richiesta</h2>
          <p>Contiene intestazioni HTTP, percorsi, indirizzi IP e informazioni di runtime. Utile per logging, routing e debug. Le chiavi più usate sono <code>REQUEST_METHOD</code>, <code>HTTP_USER_AGENT</code>, <code>REMOTE_ADDR</code> e <code>SCRIPT_NAME</code>.</p>
          <pre><code class="language-php">&lt;?php
$info = [
  'Metodo' => $_SERVER['REQUEST_METHOD'] ?? 'sconosciuto',
  'User-Agent' => $_SERVER['HTTP_USER_AGENT'] ?? 'n/d',
  'IP client' => $_SERVER['REMOTE_ADDR'] ?? 'n/d',
  'Script' => $_SERVER['SCRIPT_NAME'] ?? 'n/d'
];

echo '&lt;h3&gt;Dettagli richiesta&lt;/h3&gt;';
echo '&lt;ul&gt;';
foreach ($info as $chiave => $valore) {
  echo "&lt;li&gt;<strong>$chiave</strong>: " . htmlspecialchars($valore) . "&lt;/li&gt;";
}

echo '&lt;/ul&gt;';
?&gt;</code></pre>
        </div>

        <div class="box">
          <h2>$_COOKIE — Preferenze lato client</h2>
          <p>Associa chiave/valore salvati nel browser con una scadenza. Ricorda che il cookie è accessibile dall'utente: non conservarvi dati sensibili. Imposta l'attributo <code>HttpOnly</code> per mitigare accessi via JavaScript.</p>
          <pre><code class="language-php">&lt;?php
// Imposta un cookie per 30 giorni
setcookie('tema', 'scuro', [
  'expires' => time() + 60 * 60 * 24 * 30,
  'path' => '/',
  'httponly' => true,
  'samesite' => 'Lax'
]);

$tema = $_COOKIE['tema'] ?? 'chiaro';
echo "Tema preferito: " . htmlspecialchars($tema);
?&gt;</code></pre>
        </div>

        <div class="box">
          <h2>$_SESSION — Stato utente lato server</h2>
          <p>Memorizza dati persistenti tra richieste sul server, legati a un identificatore salvato in un cookie di sessione. Va inizializzata con <code>session_start()</code> prima di leggere o scrivere. Ideale per login, carrello, preferenze temporanee.</p>
          <pre><code class="language-php">&lt;?php
session_start();

if (!isset($_SESSION['visite'])) {
  $_SESSION['visite'] = 0;
}
$_SESSION['visite']++;

echo "Hai visitato questa pagina {$_SESSION['visite']} volte.";

echo '&lt;br&gt;&lt;a href="logout.php"&gt;Chiudi sessione&lt;/a&gt;';
?&gt;

&lt;?php // logout.php
session_start();
session_unset();
session_destroy();

echo 'Sessione terminata.';
?&gt;</code></pre>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
